{% extends "base.html" %}
{% load staticfiles %}
{% load markdown_deux_tags %}

{% block prepend_css %}
  {{ head_comment_form.media }}
{% endblock prepend_css %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-6">
      <h2><span class="text-warning">In one month</span> I want to attain the following:</h1>
      <p>{{ model.title }}</p>
      <p>{{ model.body|markdown }}</p>

      <div class="comments-container">
        <ul>
        {% for head_comment in model.headcomment_set.all %}
          <li>
            <div class="head-comment" style="border-style:solid;">
              {{ head_comment.text }}
              {{ head_comment.owner.vote.decision }}
              <div class="head-id" style="display:none;">{{ head_comment.id }}</div>             
            </div>
    
            <ul>
            {% for tail_comment in head_comment.tailcomment_set.all %}
              <li class="tail-comment" style="border-style:solid;">
                {{ tail_comment.text }}
              </li>
            {% endfor %}
            </ul>
    

            <button class="tail-comment-button" type="button" class="btn">
              Add comment 
            </button>
          </li>
        {% endfor %}
        </ul>

        <br>
        <button id="head-comment-button" type="button" class="btn" style="display:none;">
          Make vote comment
        </button>

        <form id="head-comment-form" action="" method="post" style="display:none;"> {% csrf_token %}
          {{ head_comment_form }}   
          <input type="submit" value="Post" name="head-submit">
        </form>
        <form id="tail-comment-form" action="" method="post" style="display:none;"> {% csrf_token %}
          {{ tail_comment_form }}   
          <input type="hidden" value="" name="head-id">
          <input type="submit" value="Post" name="tail-submit">
        </form>

      </div>

    </div>
  </div><!-- end div.row -->

</div><!-- end div.container -->

{% endblock content %}


{% block extra_js %}
<script type="text/javascript" src="{% static 'js/jquery-django-csrf-ajax.js' %}"></script>
<script type="text/javascript" charset="utf-8">
  $(function() {

      // This hack is not to be implemented in Pagedown directly.
      // That would make it impossible to render multiple forms on the 
      // same page properly.
      function fixExtraPageDownEditBarsRendering(){
          var $pagedownEditBars = $('.wmd-button-row');
          if ($pagedownEditBars.length >= 1) {
              var $slicedPageDownEditBars = $pagedownEditBars.slice(1);
              $slicedPageDownEditBars.each(function(index) {
                  $(this).hide()
              });
          }
      }

      // Shouldn't even be necessary:
      //var userApiUrl =  

      var roleApiUrl = "{{ role_api_url }}";
      var $headCommentButton = $('#head-comment-button');
      var $headCommentForm = $('#head-comment-form');
      var $tailCommentButton = $('.tail-comment-button');
      var $tailCommentForm = $('#tail-comment-form');

      // Show $headCommentButton in case of juror that hasn't made a headcomment yet
      $.get(roleApiUrl, function(data) {
          var role = data; 
          // remember to remove the !
          if (role.can_make_head_comment) {
              //$headCommentButton.appendTo(".comments-container");
              $headCommentButton.show();
          }
      });
      
      $headCommentButton.click(function() {
          $headCommentButton.hide();
          $headCommentForm.show();

          fixExtraPageDownEditBarsRendering();
      });

      $tailCommentButton.click(function() {
          $tailCommentForm.appendTo($(this).parent())
          $tailCommentForm.show();

          // Set clicked head id to $tailCommentForm
          var clickedHeadCommentId = $(this).parent().find(".head-id").text()
          $tailCommentForm.find("input[name='head-id']").attr("value", clickedHeadCommentId);
      } );

  })
</script>
{% endblock extra_js %}
